/*
 Hype Reactive Content 1.6.0
copyright (c) 2025 Max Ziebell, (https://maxziebell.de). MIT-license
*/
'use strict';if("HypeReactiveContent"in window===false)window["HypeReactiveContent"]=function(){const _isHypeIDE=window.location.href.indexOf("/Hype/Scratch/HypeScratch.")!=-1;const customDataMap=new WeakMap;const reactiveCache=new WeakMap;let _default={scopeSymbol:"\u21e2",visibilitySymbol:"\ud83d\udc41\ufe0f",effectSymbol:"\u26a1\ufe0f",templateSymbol:"\ud83d\udcdd",debounceCustomDataUpdate:true,visibilityMode:"auto",debug:false,trackRedraws:false,redrawHighlightDuration:250};if(_isHypeIDE)Object.assign(_default,
{highlightReactiveContent:true,highlightVisibilityData:true,highlightVisibilityArea:true,highlightActionData:true,highlightScopeData:true,highlightTemplateData:true});function highlightRedraw(element){if(!getDefault("trackRedraws")||!isHypePreview())return;requestAnimationFrame(()=>{if(!element.isConnected)return;const rect=element.getBoundingClientRect();if(rect.width===0&&rect.height===0)return;const overlay=document.createElement("div");overlay.className="hype-reactive-redraw-overlay";overlay.style.position=
"absolute";overlay.style.pointerEvents="none";overlay.style.zIndex="9999";overlay.style.top=window.scrollY+rect.top+"px";overlay.style.left=window.scrollX+rect.left+"px";overlay.style.width=rect.width+"px";overlay.style.height=rect.height+"px";document.body.appendChild(overlay);setTimeout(()=>{if(overlay&&overlay.parentNode)overlay.parentNode.removeChild(overlay)},getDefault("redrawHighlightDuration"))})}function isHypePreview(){return window.location.href.indexOf("127.0.0.1:")!=-1&&window.location.href.indexOf("/preview/")!=
-1}function setDefault(key,value){if(typeof key=="object"){_default=key;return}_default[key]=value}function getDefault(key){if(!key)return _default;return _default[key]}const isProxy=Symbol("isProxy");function isReactive(obj){return obj[isProxy]}function fullKey(_key,key){return _key?_key+"."+key:key}function enableReactiveObject(obj,callback,_key){_key=_key||"";if(obj==null||isReactive(obj))return obj;const cachedProxy=reactiveCache.get(obj);if(cachedProxy)return cachedProxy;const handler={get:function(target,
key,receiver){if(key==="_key")return _key;if(key===isProxy)return true;const result=Reflect.get(target,key,receiver);if(typeof result==="object")return enableReactiveObject(result,callback,fullKey(_key,key));return result},set:function(target,key,value,receiver){const result=Reflect.set(target,key,value,receiver);callback(key,value,target,receiver);return result}};const proxy=new Proxy(obj,handler);reactiveCache.set(obj,proxy);return proxy}function disableReactiveObject(obj){if(!isReactive(obj))return obj;
const result={};for(const key in obj)if(obj.hasOwnProperty(key)){const value=obj[key];if(typeof value==="object")result[key]=disableReactiveObject(value);else result[key]=value}return result}function debounceByRequestFrame(fn){return function(){if(fn.timeout)return;const args=arguments;fn.timeout=requestAnimationFrame(function(){fn.apply(this,args);fn.timeout=null}.bind(this))}}function runCode(code,hypeDocument,scope,options){if(scope){if(typeof scope!=="object")return null}else{if(scope===undefined)return null;
scope=hypeDocument.customData}options=options||{};if("HypeActionEvents"in window!==false)return hypeDocument.triggerAction(code,{element:options.element,event:{type:options.type},scope:scope});else try{let $context=new Proxy(Object.assign({element:options.element,$elm:options.element},hypeDocument),{set(target,key,val,receiver){if(!Reflect.get(target,key,receiver))return Reflect.set(scope,key,val);return Reflect.set(target,key,val,receiver)},get(target,key,receiver){var value=Reflect.get(target,key,
receiver);if(value)return value;return Reflect.get(scope,key)},has(target,key,receiver){if(!target.hasOwnProperty(key)&&!window[key])return true;return Reflect.has(target,key,receiver)}});return(new Function("$context","with($context){ "+code+"}"))($context)}catch(e){if(getDefault("debug")||isHypePreview())console.error("%c"+(options.errorMsg||"HypeReactiveContent Error")+"%c"+(options.errorMsg?"":" version "+HypeReactiveContent.version)+"\n\n"+"%c"+code+(!options.omitError?"%c"+"\n\n"+e+"\n\n":""),
"font-size:12px; font-weight:bold","font-size:8px","min-height:40px;display: inline-block; padding: 10px; background-color: rgba(255,255,255,0.25); border: 1px solid lightgray; border-radius: 4px; font-family:Monospace; font-size:12px","font-size:11px",options.element?options.element:"");else console.error(e)}}function isCode(code){return/[;=()]/.test(code)}function resolveScope(hypeDocument,element,scope){if(scope)return runCode("return "+scope,hypeDocument,null,{element:element,type:"HypeReactiveScope"});
return null}function resolveClosestScope(hypeDocument,element){let closestElm=element.closest("[data-scope]");if(closestElm)return resolveScope(hypeDocument,element,closestElm.getAttribute("data-scope"));return null}function processValueInScope(value,hypeDocument,elm){const scopeSymbol=getDefault("scopeSymbol");const scopeSymbolLength=scopeSymbol.length;let scope=null;value=value.trim();if(value.startsWith(scopeSymbol)){value=value.slice(scopeSymbolLength);scope=resolveClosestScope(hypeDocument,elm)}else if(value.includes(scopeSymbol)){scope=
value.slice(0,value.indexOf(scopeSymbol));scope=resolveScope(hypeDocument,elm,scope);value=value.slice(value.indexOf(scopeSymbol)+scopeSymbolLength)}return{value:value,scope:scope}}function parseTemplate(template,hypeDocument,elm){return template.replace(/{{([\s\S]*?)}}/g,function(match,expression){expression=expression.trim();if(match.charAt(0)==="\\")return match.substring(1);try{const processed=processValueInScope(expression,hypeDocument,elm);let result=runCode("return "+processed.value,hypeDocument,
processed.scope,{element:elm,type:"HypeReactiveTemplate"});return result!==undefined?result:""}catch(e){return""}})}const templateCache=new WeakMap;function initTemplates(hypeDocument){let sceneElm=document.getElementById(hypeDocument.currentSceneId());let documentTemplates=templateCache.get(hypeDocument)||new Map;sceneElm.querySelectorAll("[data-content-template]").forEach(function(elm){const templateName=elm.getAttribute("data-content-template");const templateContent=elm.innerHTML;if(templateName&&
!documentTemplates.has(templateName))documentTemplates.set(templateName,templateContent);else if(!templateName&&!documentTemplates.has(elm))documentTemplates.set(elm,templateContent)});templateCache.set(hypeDocument,documentTemplates)}function setupCustomDataProxy(hypeDocument){let currentCustomData=hypeDocument.customData||{};customDataMap.set(hypeDocument,currentCustomData);Object.defineProperty(hypeDocument,"customData",{get:function(){return customDataMap.get(hypeDocument)},set:function(newValue){const reactiveData=
enableReactiveObject(newValue,hypeDocument.refreshReactiveContentDebounced);customDataMap.set(hypeDocument,reactiveData);if(getDefault("debounceCustomDataUpdate"))hypeDocument.refreshReactiveContentDebounced();else hypeDocument.refreshReactiveContent()}})}function HypeDocumentLoad(hypeDocument,element,event){let behaviorCallbacks={};function behaviorActionHelper(elm,type,datasetKey,action,behavior){let bubbleElm=elm.closest("["+datasetKey+"-action]");if(bubbleElm)runCode(bubbleElm.getAttribute(datasetKey+
"-action"),hypeDocument,null,{element:elm,type:type});bubbleElm=elm.closest("["+datasetKey+"-behavior]");if(bubbleElm&&!behaviorCallbacks[bubbleElm.id]){behaviorCallbacks[bubbleElm.id]=true;let behavior=bubbleElm.getAttribute(datasetKey+"-behavior");debounceByRequestFrame(function(){hypeDocument.triggerCustomBehaviorNamed(behavior)})()}}hypeDocument.refreshReactiveContent=function(key,value,target,receiver){if(key!==undefined&&value!==undefined&&!isCode(value))hypeDocument.triggerCustomBehaviorNamed(fullKey(receiver._key,
key)+" equals "+(typeof value==="string"?'"'+value+'"':value));if(key!==undefined){if(getDefault("customDataUpdate"))getDefault("customDataUpdate")(key,value,target,receiver);if(hypeDocument.customDataUpdate)hypeDocument.customDataUpdate(key,value,target,receiver);hypeDocument.triggerCustomBehaviorNamed("customData was changed");hypeDocument.triggerCustomBehaviorNamed(fullKey(receiver._key,key)+" was updated")}let sceneElm=document.getElementById(hypeDocument.currentSceneId());behaviorCallbacks={};
sceneElm.querySelectorAll("[data-visibility], [data-content], [data-effect], [data-content-template]").forEach(function(elm){let content=elm.getAttribute("data-content");let visibility=elm.getAttribute("data-visibility");let effect=elm.getAttribute("data-effect");let hasTemplate=elm.hasAttribute("data-content-template");if(visibility){const processed=processValueInScope(visibility,hypeDocument,elm);let result=runCode("return "+processed.value,hypeDocument,processed.scope,{element:elm,type:"HypeReactiveVisibility"});
if(elm.style.display=="none")elm.style.display="block";let newVisibility=result?"visible":"hidden";if(newVisibility!==elm.style.visibility){elm.style.visibility=newVisibility;if(key)behaviorActionHelper(elm,"HypeReactiveVisibilityChanged","data-visibility-changed",true,true)}}if(effect){const processed=processValueInScope(effect,hypeDocument,elm);runCode(processed.value,hypeDocument,processed.scope,{element:elm,type:"HypeReactiveEffect"})}if(content){const processed=processValueInScope(content,hypeDocument,
elm);let result=runCode("return "+processed.value,hypeDocument,processed.scope,{element:elm,type:"HypeReactiveContent"});if(result!==null){const tempDiv=document.createElement("div");const isNodeResult=result instanceof HTMLElement||result instanceof DocumentFragment;if(isNodeResult)tempDiv.appendChild(result.cloneNode(true));else{result=result!==undefined?result:"";tempDiv.innerHTML=result}const normalizedNew=tempDiv.innerHTML;if(normalizedNew!==elm.innerHTML){if(isNodeResult){elm.innerHTML="";elm.appendChild(result)}else elm.innerHTML=
normalizedNew;highlightRedraw(elm);if(key)behaviorActionHelper(elm,"HypeReactiveContentChanged","data-content-changed",true,true)}}}else if(hasTemplate){let templateName=elm.getAttribute("data-content-template");const documentTemplates=templateCache.get(hypeDocument)||new Map;let templateContent=templateName?documentTemplates.get(templateName):documentTemplates.get(elm);if(templateContent){const renderedTemplate=parseTemplate(templateContent,hypeDocument,elm);const tempDiv=document.createElement("div");
tempDiv.innerHTML=renderedTemplate;const normalizedHTML=tempDiv.innerHTML;if(normalizedHTML!==elm.innerHTML){elm.innerHTML=normalizedHTML;highlightRedraw(elm);if(key)behaviorActionHelper(elm,"HypeReactiveTemplateChanged","data-content-template-changed",true,true)}}else elm.innerHTML=""}});if("HypeDataMagic"in window!==false)if(HypeDataMagic.getDefault("refreshOnCustomData"))hypeDocument.refresh()};hypeDocument.refreshReactiveContentDebounced=debounceByRequestFrame(hypeDocument.refreshReactiveContent);
hypeDocument.resolveClosestScope=function(elm){return resolveClosestScope(hypeDocument,elm)};hypeDocument.enableReactiveCustomData=function(data){const existingData=customDataMap.get(hypeDocument)||{};hypeDocument.customData=Object.assign(existingData,data||{})};hypeDocument.setContentTemplateByName=function(templateName,templateContent,forceRefresh=true){let documentTemplates=templateCache.get(hypeDocument)||new Map;documentTemplates.set(templateName,templateContent);templateCache.set(hypeDocument,
documentTemplates);if(forceRefresh)hypeDocument.refreshReactiveContentDebounced()};hypeDocument.setContentTemplates=function(templates,forceRefresh=true){if(templates&&typeof templates==="object"){for(let templateName in templates)if(templates.hasOwnProperty(templateName))hypeDocument.setContentTemplateByName(templateName,templates[templateName],false);if(forceRefresh)hypeDocument.refreshReactiveContentDebounced()}};hypeDocument.flushContentTemplateByName=function(templateName,forceRefresh=true){const documentTemplates=
templateCache.get(hypeDocument);if(documentTemplates&&templateName){documentTemplates.delete(templateName);templateCache.set(hypeDocument,documentTemplates);if(forceRefresh)hypeDocument.refreshReactiveContentDebounced()}};hypeDocument.flushContentTemplates=function(forceRefresh=true){const documentTemplates=templateCache.get(hypeDocument);if(documentTemplates){documentTemplates.clear();templateCache.set(hypeDocument,documentTemplates);if(forceRefresh)hypeDocument.refreshReactiveContentDebounced()}};
setupCustomDataProxy(hypeDocument);hypeDocument.enableReactiveCustomData(getDefault("customData")||{});if(hypeDocument.functions().HypeReactiveContent)hypeDocument.functions().HypeReactiveContent(hypeDocument,element,event)}function HypeTriggerCustomBehavior(hypeDocument,element,event){if("HypeActionEvents"in window!==false)return;const code=event.customBehaviorName;if(code.charAt(0)=="#")return;if(isCode(code))runCode(code,hypeDocument,hypeDocument.customData)}function HypeScenePrepareForDisplay(hypeDocument,
element,event){initTemplates(hypeDocument);hypeDocument.refreshReactiveContent()}if("HYPE_eventListeners"in window===false)window.HYPE_eventListeners=Array();window.HYPE_eventListeners.push({"type":"HypeDocumentLoad","callback":HypeDocumentLoad});window.HYPE_eventListeners.push({type:"HypeScenePrepareForDisplay",callback:HypeScenePrepareForDisplay});if("HypeActionEvents"in window===false)window.HYPE_eventListeners.push({"type":"HypeTriggerCustomBehavior","callback":HypeTriggerCustomBehavior});if(_isHypeIDE)window.addEventListener("DOMContentLoaded",
function(event){if(getDefault("highlightReactiveContent")){let labelBase="font-family:Helvetica,Arial;line-height:11px;font-size:9px;font-weight:normal;padding:2px 5px;white-space:nowrap;max-height:16px;color:#000;text-align:center;background-color:var(--data-reactive-color);";let labelTop="position:absolute;top:-15px;left:-1px;border-top-right-radius:.2rem;border-top-left-radius:.2rem;";let labelBottom="position:absolute;bottom:-15px;left:-1px;border-bottom-right-radius:.2rem;border-bottom-left-radius:.2rem";
let colorScoped="#ffcccc";let colorContent="#f8d54f";let rules=["[data-scope] [data-content*\x3d"+getDefault("scopeSymbol")+"],"+"[data-scope] [data-effect*\x3d"+getDefault("scopeSymbol")+"],"+"[data-scope] [data-visibility*\x3d"+getDefault("scopeSymbol")+"]"+"{--data-reactive-color: "+colorScoped+"}","[data-content], [data-effect], [data-visibility], [data-content-template]"+"{--data-reactive-color: "+colorContent+"}"];document.documentElement.style.setProperty("--data-reactive-color",colorContent);
if(getDefault("highlightActionData"))rules=rules.concat(["[data-content]{outline:1px dashed var(--data-reactive-color);position:relative}","[data-content]::before{content:attr(data-content);"+labelBase+labelTop+"}","[data-effect]::before{content:'"+getDefault("effectSymbol")+" ' attr(data-effect);"+labelBase+labelTop+"}","[data-content][data-effect]::before{content: attr(data-content) ' "+getDefault("effectSymbol")+" ' attr(data-effect)}"]);if(getDefault("highlightTemplateData"))rules=rules.concat(["[data-content-template]{outline:1px dashed var(--data-reactive-color);position:relative}",
"[data-content-template]::before{content:'"+getDefault("templateSymbol")+" ' attr(data-content-template);"+labelBase+labelTop+"}"]);if(getDefault("highlightVisibilityData"))rules=rules.concat(["[data-visibility]::before{content:'"+getDefault("visibilitySymbol")+" ' attr(data-visibility);"+labelBase+labelTop+"}"]);if(getDefault("highlightScopeData"))rules=rules.concat(["[data-scope]{--data-reactive-color:"+colorScoped+"; outline:1px dashed var(--data-reactive-color);}","[data-scope]::after{content:attr(data-scope);"+
labelBase+labelBottom+"}"]);if(getDefault("highlightActionData")&&getDefault("highlightVisibilityData"))rules=rules.concat(["[data-content][data-visibility]:not([data-effect])::before{content: attr(data-content) ' "+getDefault("visibilitySymbol")+" ' attr(data-visibility)}","[data-effect][data-visibility]:not([data-content])::before{content: ' "+getDefault("effectSymbol")+" ' attr(data-effect) ' "+getDefault("visibilitySymbol")+" ' attr(data-visibility)}","[data-content][data-effect][data-visibility]::before{content: attr(data-content)  ' "+
getDefault("effectSymbol")+" ' attr(data-effect) ' "+getDefault("visibilitySymbol")+" ' attr(data-visibility)}"]);if(getDefault("highlightVisibilityArea"))rules=rules.concat(["[data-visibility]:not([data-scope])::after {content:'';position: absolute;top: 0;left: 0;width: 100%;height: 100%;background-image:repeating-linear-gradient(45deg,transparent,transparent 10px,var(--data-reactive-color) 10px,var(--data-reactive-color) 20px);opacity: .1;}"]);rules.forEach(rule=>document.styleSheets[0].insertRule(rule,
0))}});else window.addEventListener("DOMContentLoaded",function(event){let visibilityMode=getDefault("visibilityMode");let rules=[];if(isHypePreview())rules.push(".hype-reactive-redraw-overlay {"+"box-sizing: border-box;"+"background-color: rgba(255, 0, 0, 0.2);"+"border: 1px solid rgba(255, 0, 0, 0.5);"+"}");switch(visibilityMode){case "auto":rules.push('[data-visibility][style*\x3d"visibility: hidden"] [data-visibility] { visibility: hidden !important; }');break;case "manual":rules.push('[style*\x3d"visibility: hidden"] .inheritVisibility { visibility: hidden !important; }',
'.propagateVisibility[data-visibility][style*\x3d"visibility: hidden"] [data-visibility] { visibility: hidden !important; }');break;case "none":default:break}rules.forEach(rule=>document.styleSheets[0].insertRule(rule,0))});return{version:"1.6.0",setDefault:setDefault,getDefault:getDefault,enableReactiveObject:enableReactiveObject,disableReactiveObject:disableReactiveObject,debounceByRequestFrame:debounceByRequestFrame}}();
